<!DOCTYPE html>
<html>
<head>
    <title>–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container mt-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h1 class="h4 mb-0">üè• –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∫–∞—Ä—Ç–∞</h1>
            </div>
            
            <div class="card-body">
                {% if message %}
                    <div class="alert {% if '‚úÖ' in message %}alert-success{% else %}alert-danger{% endif %}">
                        {{ message }}
                    </div>
                {% endif %}

                <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
                <form method="post" class="row g-3 mb-4">
                    {% csrf_token %}
                    <div class="col-md-4">
                        <input type="text" name="name" class="form-control" placeholder="–§–ò–û" required>
                    </div>
                    <div class="col-md-2">
                        <input type="number" name="height" class="form-control" placeholder="–†–æ—Å—Ç" required>
                    </div>
                    <div class="col-md-2">
                        <input type="text" name="pressure" class="form-control" placeholder="–î–∞–≤–ª–µ–Ω–∏–µ" required>
                    </div>
                    <div class="col-md-2">
                        <input type="number" name="glucose" class="form-control" placeholder="–ì–ª—é–∫–æ–∑–∞" step="0.1" required>
                    </div>
                    <div class="col-md-2">
                        <input type="number" name="age" class="form-control" placeholder="–í–æ–∑—Ä–∞—Å—Ç" required>
                    </div>
                    
                    <div class="col-12">
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="save_to" value="json" checked>
                            <label class="form-check-label">üìÑ JSON</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="save_to" value="db">
                            <label class="form-check-label">üóÉÔ∏è –ë–î</label>
                        </div>
                        <button type="submit" class="btn btn-success float-end">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>
                </form>

                <!-- –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
                <form method="post" enctype="multipart/form-data" class="mb-4">
                    {% csrf_token %}
                    <div class="input-group">
                        <input type="file" name="json_file" class="form-control" accept=".json" required>
                        <button type="submit" class="btn btn-outline-primary">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å JSON</button>
                    </div>
                </form>

                <!-- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ -->
                <div class="mb-3">
                    <div class="btn-group">
                        <a href="?source=json" class="btn {% if data_source == 'json' %}btn-warning{% else %}btn-outline-warning{% endif %}">üìÑ JSON</a>
                        <a href="?source=db" class="btn {% if data_source == 'db' %}btn-info{% else %}btn-outline-info{% endif %}">üóÉÔ∏è –ë–î</a>
                    </div>
                    <small class="text-muted ms-2">–ò—Å—Ç–æ—á–Ω–∏–∫: {% if data_source == 'json' %}JSON{% else %}–ë–î{% endif %}</small>
                </div>

                <!-- –ü–æ–∏—Å–∫ –¥–ª—è –ë–î -->
                {% if data_source == 'db' %}
                <div class="mb-3">
                    <input type="text" id="searchInput" class="form-control" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏...">
                    <div id="searchResults" class="mt-2"></div>
                </div>
                {% endif %}

                <!-- –°–ø–∏—Å–æ–∫ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ -->
                <h5>üë• –ü–∞—Ü–∏–µ–Ω—Ç—ã ({{ patients|length }})</h5>
                
                {% if patients %}
                    <div class="row">
                        {% for patient in patients %}
                            <div class="col-md-6 mb-2">
                                <div class="card">
                                    <div class="card-body py-2">
                                        <div class="d-flex justify-content-between">
                                            <h6 class="card-title mb-1">üë§ {{ patient.name }}</h6>
                                            <span class="badge {% if patient.from_db %}bg-info{% else %}bg-warning{% endif %}">
                                                {% if patient.from_db %}–ë–î{% else %}JSON{% endif %}
                                            </span>
                                        </div>
                                        <p class="card-text small mb-1">
                                            üìè {{ patient.height }}—Å–º ‚Ä¢ üíì {{ patient.pressure }} ‚Ä¢ ü©∏ {{ patient.glucose }} ‚Ä¢ üéÇ {{ patient.age }}–ª–µ—Ç
                                        </p>
                                        {% if patient.from_db %}
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-danger" onclick="deletePatient({{ patient.id }})">üóëÔ∏è</button>
                                                <button class="btn btn-outline-primary" onclick="editPatient({{ patient.id }})">‚úèÔ∏è</button>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="alert alert-info text-center">
                        üì≠ –ü–∞—Ü–∏–µ–Ω—Ç–æ–≤ –Ω–µ—Ç
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        // –ü–æ–∏—Å–∫
        document.getElementById('searchInput')?.addEventListener('input', function() {
            const query = this.value;
            if (query.length > 2) {
                fetch(`/search/?q=${query}`)
                    .then(r => r.json())
                    .then(data => {
                        const results = document.getElementById('searchResults');
                        results.innerHTML = data.patients.map(p => `
                            <div class="card mb-1">
                                <div class="card-body py-2">
                                    <h6 class="mb-0">${p.name}</h6>
                                    <small>üìè ${p.height}—Å–º ‚Ä¢ üéÇ ${p.age}–ª–µ—Ç</small>
                                </div>
                            </div>
                        `).join('');
                    });
            }
        });

        // –£–¥–∞–ª–µ–Ω–∏–µ
        function deletePatient(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å?')) {
                fetch(`/patient/${id}/delete/`, {
                    method: 'POST',
                    headers: {'X-CSRFToken': '{{ csrf_token }}'}
                }).then(r => r.json()).then(data => data.success && location.reload());
            }
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        function editPatient(id) {
            const name = prompt('–ù–æ–≤–æ–µ –∏–º—è:');
            if (name) {
                const formData = new FormData();
                formData.append('name', name);
                formData.append('height', '175');
                formData.append('pressure', '120/80');
                formData.append('glucose', '5.5');
                formData.append('age', '30');
                
                fetch(`/patient/${id}/update/`, {
                    method: 'POST',
                    body: formData,
                    headers: {'X-CSRFToken': '{{ csrf_token }}'}
                }).then(r => r.json()).then(data => data.success && location.reload());
            }
        }
    </script>
</body>
</html>