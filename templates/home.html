<!DOCTYPE html>
<html>
<head>
    <title>–ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="container">
        <h1>üè• –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è –∫–∞—Ä—Ç–∞</h1>
        
        {% if message %}
            <div class="message {% if '‚úÖ' in message %}success{% else %}error{% endif %}">
                {{ message }}
            </div>
        {% endif %}
        
        <!-- –§–æ—Ä–º–∞ –¥–ª—è –≤–≤–æ–¥–∞ –¥–∞–Ω–Ω—ã—Ö -->
        <form method="post">
            {% csrf_token %}
            
            <div class="form-group">
                <label>–§–ò–û –ø–∞—Ü–∏–µ–Ω—Ç–∞:</label>
                <input type="text" name="name" required placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á">
            </div>
            
            <div class="form-group">
                <label>–†–æ—Å—Ç (—Å–º):</label>
                <input type="number" name="height" required placeholder="175">
            </div>
            
            <div class="form-group">
                <label>–î–∞–≤–ª–µ–Ω–∏–µ:</label>
                <input type="text" name="pressure" required placeholder="120/80">
            </div>
            
            <div class="form-group">
                <label>–ì–ª—é–∫–æ–∑–∞ (–º–º–æ–ª—å/–ª):</label>
                <input type="number" name="glucose" required placeholder="5.5" step="0.1">
            </div>
            
            <div class="form-group">
                <label>–í–æ–∑—Ä–∞—Å—Ç (–ª–µ—Ç):</label>
                <input type="number" name="age" required placeholder="15">
            </div>

            <!-- –í—ã–±–æ—Ä –∫—É–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å -->
            <div class="form-group">
                <label>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤:</label>
                <div class="radio-group">
                    <div class="radio-option">
                        <input type="radio" id="json" name="save_to" value="json" checked>
                        <label for="json">üìÑ JSON —Ñ–∞–π–ª</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="db" name="save_to" value="db">
                        <label for="db">üóÉÔ∏è –ë–∞–∑—É –¥–∞–Ω–Ω—ã—Ö</label>
                    </div>
                </div>
            </div>
            
            <button type="submit" class="btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ü–∏–µ–Ω—Ç–∞</button>
        </form>

        <hr>

        <!-- –§–æ—Ä–º–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ -->
        <form method="post" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-group">
                <label>–ó–∞–≥—Ä—É–∑–∏—Ç—å JSON —Ñ–∞–π–ª:</label>
                <input type="file" name="json_file" accept=".json" required>
            </div>
            <button type="submit" class="btn-secondary">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
        </form>
        
        <hr>
        
        <!-- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏ -->
        <div class="source-buttons">
            <h4>–ü–æ–∫–∞–∑–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑:</h4>
            <a href="?source=json" class="btn-source btn-json {% if data_source == 'json' %}active{% endif %}">
                üìÑ JSON —Ñ–∞–π–ª–∞
            </a>
            <a href="?source=db" class="btn-source btn-db {% if data_source == 'db' %}active{% endif %}">
                üóÉÔ∏è –ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
            </a>
            
            <div class="current-source">
                –°–µ–π—á–∞—Å –ø–æ–∫–∞–∑–∞–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑: 
                <strong>{% if data_source == 'json' %}JSON —Ñ–∞–π–ª–∞{% else %}–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö{% endif %}</strong>
            </div>
        </div>

        <!-- AJAX –ø–æ–∏—Å–∫ (—Ç–æ–ª—å–∫–æ –¥–ª—è –ë–î) -->
        {% if data_source == 'db' %}
        <div class="form-group">
            <label>–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ (AJAX):</label>
            <input type="text" id="searchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –¥–ª—è –ø–æ–∏—Å–∫–∞...">
            <div id="searchResults"></div>
        </div>
        {% endif %}
        
        <h2>üë• –°–ø–∏—Å–æ–∫ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤:</h2>
        
        {% if patients %}
            <div class="patients-list">
                {% for patient in patients %}
                    <div class="patient-item">
                        <h3>üë§ {{ patient.name }}</h3>
                        <ul>
                            <li>üìè –†–æ—Å—Ç: {{ patient.height }} —Å–º</li>
                            <li>üíì –î–∞–≤–ª–µ–Ω–∏–µ: {{ patient.pressure }}</li>
                            <li>ü©∏ –ì–ª—é–∫–æ–∑–∞: {{ patient.glucose }} –º–º–æ–ª—å/–ª</li>
                            <li>üéÇ –í–æ–∑—Ä–∞—Å—Ç: {{ patient.age }} –ª–µ—Ç</li>
                            
                            <li class="source-info">
                                {% if patient.from_db %}
                                    üóÉÔ∏è –ò–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö 
                                    <!-- –ö–Ω–æ–ø–∫–∏ –¥–ª—è –∑–∞–ø–∏—Å–µ–π –∏–∑ –ë–î -->
                                    <div class="patient-actions">
                                        <button class="btn-delete" onclick="deletePatient({{ patient.id }})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                                        <button class="btn-edit" onclick="editPatient({{ patient.id }})">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                    </div>
                                {% else %}
                                    üìÅ –ò–∑ JSON —Ñ–∞–π–ª–∞
                                {% endif %}
                            </li>
                        </ul>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="no-patients">
                {% if data_source == 'json' %}
                    üìÅ –í JSON —Ñ–∞–π–ª–µ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç
                {% else %}
                    üóÉÔ∏è –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç
                {% endif %}
            </div>
        {% endif %}
    </div>

    <script>
        // AJAX –ø–æ–∏—Å–∫
        document.getElementById('searchInput')?.addEventListener('input', function() {
            const query = this.value;
            if (query.length > 2) {
                fetch(`/search/?q=${query}`)
                    .then(response => response.json())
                    .then(data => {
                        const results = document.getElementById('searchResults');
                        results.innerHTML = '';
                        data.patients.forEach(patient => {
                            results.innerHTML += `
                                <div class="patient-item">
                                    <h4>${patient.name}</h4>
                                    <p>–†–æ—Å—Ç: ${patient.height}—Å–º | –í–æ–∑—Ä–∞—Å—Ç: ${patient.age}</p>
                                </div>
                            `;
                        });
                    });
            }
        });

        // –£–¥–∞–ª–µ–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞
        function deletePatient(patientId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–∞—Ü–∏–µ–Ω—Ç–∞?')) {
                fetch(`/patient/${patientId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
                    }
                });
            }
        }

        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–∞
        function editPatient(patientId) {
            const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è:');
            if (newName) {
                // –ü—Ä–æ—Å—Ç–∞—è –≤–µ—Ä—Å–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                const formData = new FormData();
                formData.append('name', newName);
                formData.append('height', '175'); // –ó–¥–µ—Å—å –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                formData.append('pressure', '120/80');
                formData.append('glucose', '5.5');
                formData.append('age', '30');
                
                fetch(`/patient/${patientId}/update/`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏');
                    }
                });
            }
        }
    </script>
</body>
</html>